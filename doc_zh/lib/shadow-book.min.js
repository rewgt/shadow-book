// shadow-book cdn ver 0.1.1
window.W||(window.W=new Array,W.$modules=[]),W.$modules.push(function(a,b,c){function l(){function b(a){var c,d,e,b=0;if(0==a.length)return b;for(c=0,e=a.length;c<e;c++)d=a.charCodeAt(c),b=(b<<5)-b+d,b|=0;return b}var a=window.location.pathname||"untitled";"/"==a.slice(-1)&&(a+="index.html"),this.canSave=!!window.localStorage,this.bookPath=a,this.bookId=b(a)+"",this.config={}}function n(a,b){function c(a,b){h.ajax({type:"GET",url:b,timeout:3e4,dataType:"json",success:function(b,c,d){if(Array.isArray(b)&&b.length>=1){var e=b[0];if("object"!=typeof e||Array.isArray(e))e={};else if(b.shift(),e.title&&(document.title=e.title+""),"number"==typeof e.navPanelWidth&&(a.duals.width=e.navPanelWidth),e.ctrlPanelLib){var f=document.createElement("script");f.setAttribute("type","text/javascript"),f.setAttribute("src",e.ctrlPanelLib+""),document.body.appendChild(f)}m.clearBefore(Math.floor((new Date).valueOf()/1e3)-24*(e.storageExpiredDays||250)*3600),m.loadItems(),b.forEach(function(a,b){var c=a[1];c&&m.getItem(c)&&a.push("done")}),a.duals.data=b}},error:function(a,b){console.log("warning: query book summary failed ("+(b||"unknown error")+")")}})}if(a<=2)return void(1==a&&this.defineDual("json",function(a,b){a&&c(this,a)}))}function p(a){for(var b=a.target,c=null;b;){if("LI"==b.nodeName){c=b;break}b=b.parentNode}if(c){var d=c.dataset.idx||"";d&&(this.duals.goTo=[d,i.time()])}}function q(a,b){function g(a){return function(){var b=window.location.hash;b=b&&"#"==b[0]?decodeURIComponent(b.slice(1)):"",a.duals.goTo=[b,i.time()]}}function j(a,b,c,d){var e=c.previousElementSibling,f="";e&&"LI"==e.nodeName&&(f=e.dataset.idx||"");var g=c.nextElementSibling,j="";g&&"LI"==g.nodeName&&(j=g.dataset.idx||"");var k=c.dataset.idx||"",l=c.dataset.url;if(l){if(k){var n=Math.floor((new Date).valueOf()/1e3);m.setItem(k,n)}var o,p=a.state.data,q=h.keyOfNode(c),r=parseInt(q);!isNaN(r)&&(o=p[r])&&(o=o.slice(0),o.indexOf("done")<0&&o.push("done"),p=i.update(p,{$splice:[[r,1,o]]})),a.state.currIndex=k,a.componentOf("//").duals.data=p,a.duals.jumpTo=[f,j,k,l,d||"",c.textContent]}}if(a<=2)if(1==a){o=this,this.state.currIndex="",this.defineDual("jumpTo",function(a,b){});var c=!0;this.defineDual("goTo",function(a,b){var d=null,e=this.getHtmlNode();if(e){var f=a[0],g="",h=f.indexOf("!");h>=0&&(g=f.slice(h+1).trim(),f=f.slice(0,h));try{d=f?e.querySelector('li[data-idx="'+f+'"]'):e.querySelector("li[data-idx]")}catch(a){}d&&(j(this,e,d,g),c&&d.scrollIntoView(!1))}},["",0]),window.onhashchange=g(this),this.listen("data",function(a,b){a&&(b&&0!=b.length||(window.onhashchange(),setTimeout(function(){c=!1},300)))})}else 0==a&&(o=null);else{var d=[],e=this.state.data,f=this.state.currIndex;e.forEach(function(a,b){for(var l,c=[],e=a[0]||0,g=a[1]||"",i=a[2]||"",j=a[3]||"",k=4;l=a[k];k++)"string"==typeof l&&c.push(l);g&&g===f&&c.push("active");var m={key:b+"","data-url":j,"data-idx":g};c.length&&(m.klass=c.join(" ")),e<0?(m.style={display:"none"},m.margin=[6,0,6,0]):m.margin=[6,0,6,10*e];var n=[["Li",m]],o="0"==g||0==g.indexOf("0.")?"":g;n.push(["Span",{key:"0",klass:"summary_id","html.":o}]),n.push(["Span",{key:"1","html.":i}]),d.push(h.loadElement(n))}),h.setChildren(this,d)}}function u(a,b){if(a<=2)return void(1==a?(this.defineDual("jumpTo",function(a,b){if(a.length>=5){var c=a[0],d=a[1],e=a[2];r&&(r.duals.klass=c?"book_to_prev":"",r.duals["data-id"]=c),s&&(s.duals.klass=d?"book_to_next":"",s.duals["data-id"]=d);var g=a[3],i=a[4];if(g){if(f.__debug__)return void console.log("open md:",g);h.ajax({type:"GET",url:g,timeout:3e4,dataType:"text",success:function(a,b,c){t&&(t.duals["html."]=a);var d="#"+encodeURIComponent(e);i&&(d+="!"+i,setTimeout(function(){try{var a=document.querySelector('a[name="'+i+'"]');a&&a.scrollIntoView(!0)}catch(a){}},300)),window.location.hash!=d&&window.history.pushState(null,"section: "+e,d)},error:function(a,b){console.log("warning: query md file failed ("+g+")")}})}}},[]),this.defineDual("summaryPath",function(a,b){if(b){var c=".list"===b.slice(-5)?b:b+".list",d=this.componentOf(c);d&&d.unlisten("*",this)}if(a){var c=".list"===a.slice(-5)?a:a+".list",d=this.componentOf(c);d?d.listen("jumpTo",this,"jumpTo"):console.log("error: can not locate component ("+c+")")}})):2==a?(r=this.componentOf("prev"),s=this.componentOf("next"),t=this.componentOf("mark")):0==a&&(r=null,s=null,t=null))}function v(a,b){function e(a){var b=t&&t.getHtmlNode();b&&(b.scrollTop=0,b.scrollLeft=0)}if(a<=2)return void(1==a&&this.defineDual("data-src",function(a,b){if(a){var c=this.componentOf("img");c&&c.isHooked&&(c.duals.src=a)}}));if(1==b){var c=["Img",{key:"img",style:{width:"100%",height:"100%",backgroundColor:"rgba(0,0,0,0.04)"},src:this.state["data-src"]||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAn1BMVEUAAAD///////////////////////////////8AAAAHBwcICAgJCQkLCwsMDAwdHR05OTk6Ojo7Ozs8PDw9PT0+Pj4/Pz9DQ0NERERFRUVGRkZISEhJSUlMTExNTU1/f3+UlJSXl5ecnJyfn5+3t7e4uLi5ubnBwcHCwsLDw8PExMTx8fHy8vLz8/P09PT19fX29vb4+Pj5+fn6+vr////GdZrgAAAACXRSTlMATU7i5OXm5/HEWyOWAAAAAWJLR0Q0qbHp/QAAAN9JREFUOMvVkckSgjAQRImKJm6I+44Lirug/f/f5sSKqQihLG/aB2CmX8gk7Th/okIRVhWZAlzkqKQAYN23aA1oIBAWBd8AH7YoG3MliVG4r2NWdOsyGl91UWGp6+A4toTwT+DMel0cJ18Ol0NoP4cgPx6QWa3SYxhnCLm+TVYzihr0ap9TBPnnztMHoiZ9dN4J7e/k6bKE9LvK5xzYSaJrEC5uE2rVQvIZ0QhrVE7vRtwL6W/wXKOJpRHWTIj6FuqfktgQMTeAldc/QO8piX3PW6XTfJvakqaZXbbz23oAhlQ3P/v7RVUAAAAASUVORK5CYII=",$onClick:e}];h.setChildren(this,[h.loadElement(c)]),this.componentOf(".body").listen("innerSize",function(a,b){this.reRender()}.bind(this))}var d=this.componentOf(".body").duals.innerSize;this.state.left=d[0]-this.state.width-(parseInt(this.state["data-right"])||4),this.state.top=d[1]-this.state.height-(parseInt(this.state["data-bottom"])||4)}var f=(a("react"),a("react-dom"),a("shadow-widget")),g=f.$main,h=f.$utils,i=f.$ex,k=(f.$idSetter,"rewgt/shadow-book/");l.prototype={clearBefore:function(a){if(this.canSave){var b=localStorage.getItem(k+"books");if(b){b=JSON.parse(b);var c=[];for(var d in b){var e=localStorage.getItem(k+d);if(e){e=JSON.parse(e);var f=0,g=[];for(var h in e)f+=1,e[h]<a&&g.push(h);f==g.length?(localStorage.removeItem(k+d),c.push(d)):g.length&&(g.forEach(function(a){delete e[a]}),localStorage.setItem(k+d,JSON.stringify(e)))}}c.length&&(c.forEach(function(a){delete b[a]}),localStorage.setItem(k+"books",JSON.stringify(b)))}}},loadItems:function(){if(this.config={},this.canSave){var a=JSON.parse(localStorage.getItem(k+"books")||"{}");a[this.bookId]||(a[this.bookId]=this.bookPath,localStorage.setItem(k+"books",JSON.stringify(a))),this.config=JSON.parse(localStorage.getItem(k+this.bookId)||"{}")}},setItem:function(a,b){this.config[a]=b,this.canSave&&localStorage.setItem(k+this.bookId,JSON.stringify(this.config))},getItem:function(a){return this.config[a]}};var m=new l,o=null,r=null,s=null,t=null,w=null;g.$$onLoad.push(function(a){function b(a){if(!f.__design__){var b=a.target.getAttribute("data-id");b&&o&&(o.duals.goTo=[b,i.time()])}}h.setVendorLib("rewgt",function(c){if(!w){var d=h.loadElement([["Panel",{key:"book_summary",width:240,klass:"auto-hidden-visible default-large-small",style:{backgroundColor:"#fafafa"},json:"","dual-data":[],$id__:n}],["Ul",{key:"list",width:.9999,padding:[0,0,12,4],klass:"default-square-circle default-large-small auto-hidden-visible book_summary",style:{color:"#444"},$data:"duals.data",$onClick:p,$id__:q}]]),e=h.loadElement([["Panel",{key:"book_content",summaryPath:"",$id__:u}],["Panel",{key:"prev","data-id":"",width:36,height:.9999,$onClick:b}],["MarkedDiv",{key:"mark",width:-1,height:.9999,style:{overflow:"auto"}}],["Panel",{key:"next","data-id":"",width:36,height:.9999,$onClick:b}]]),f=h.loadElement([["Div",{key:"book_top",width:0,height:0,"data-width":"32","data-height":"32","data-right":"4","data-bottom":"4","data-src":"","data-title":""}],["P",{key:"p",margin:[0,0,0,0],$id__:v,$title:'duals["data-title"]',$width:'ex.parseInt(duals["data-width"])',$height:'ex.parseInt(duals["data-height"])',"$data-right":'duals["data-right"]',"$data-bottom":'duals["data-bottom"]',"$data-src":'duals["data-src"]',style:{position:"absolute",zIndex:"999"}}]]);w=[d,e,f]}c.setChild(w[0],w[1],w[2],a)})})});